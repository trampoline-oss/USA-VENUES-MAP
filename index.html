
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>US Venues — Unlockable Map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <style>
    html, body { height: 100%; margin: 0; font-family: system-ui, -apple-system, 'Segoe UI', Roboto, Arial, sans-serif; }
    #app { display: grid; grid-template-columns: 320px 1fr; height: 100%; }
    #sidebar { border-right: 1px solid #e5e7eb; padding: 12px; overflow-y: auto; }
    #map { width: 100%; height: 100%; }
    h1 { font-size: 18px; margin: 8px 0 4px; }
    .muted { color: #6b7280; font-size: 12px; margin-bottom: 12px; }
    .stat { display: flex; gap: 8px; align-items: baseline; margin: 8px 0; }
    .stat b { font-size: 20px; }
    .controls { display: flex; gap: 8px; flex-wrap: wrap; margin: 8px 0 12px; }
    button { cursor: pointer; border: 1px solid #d1d5db; background: #fff; padding: 6px 10px; border-radius: 6px; }
    button:hover { background: #f3f4f6; }
    input[type="search"] { width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; margin: 8px 0; }
    .venue { display: flex; align-items: center; justify-content: space-between; padding: 6px 0; border-bottom: 1px dashed #eee; }
    .venue label { display: flex; gap: 8px; align-items: center; cursor: pointer; max-width: 70%; }
    .badge { font-size: 10px; padding: 2px 6px; border-radius: 999px; background: #eef2ff; color: #3730a3; }
    details > summary { cursor: pointer; margin: 8px 0; }
    textarea { width: 100%; height: 120px; border: 1px solid #d1d5db; border-radius: 6px; padding: 8px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .small { font-size: 12px; color: #6b7280; }
    .link { color: #2563eb; text-decoration: underline; cursor: pointer; }
    .pill { padding: 2px 6px; border: 1px solid #d1d5db; border-radius: 999px; font-size: 11px; }
    .row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
  </style>
</head>
<body>
<div id="app">
  <aside id="sidebar">
    <h1>US Venues — Unlockable Map</h1>
    <div class="muted">Click a venue pin or checkbox to toggle <b>Visited</b>. Your progress saves in this browser only.</div>

    <div class="stat"><b id="unlockedCount">0</b><span>unlocked</span><span class="muted">/</span><span id="totalCount">0</span></div>
    <div class="row">
      <span id="percent" class="pill">0%</span>
      <button id="resetBtn" title="Clear visited state for this device">Reset progress</button>
      <button id="fitBtn" title="Zoom the map to show all venues">Fit to all</button>
    </div>

    <input id="search" type="search" placeholder="Search venue or city…" />

    <details>
      <summary>Import / Export</summary>
      <div class="small" style="margin:6px 0 8px">Paste venues JSON or CSV (name,city,state,lat,lng). Then <b>Load</b>.</div>
      <textarea id="dataBox" placeholder='[{"id":"coachella","name":"Empire Polo Club","city":"Indio","state":"CA","lat":33.6803,"lng":-116.2377}]'></textarea>
      <div class="controls">
        <button id="exportBtn">Export JSON</button>
        <button id="loadBtn">Load</button>
      </div>
    </details>

    <div id="list"></div>
  </aside>
  <main id="map"></main>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script>
// --- Config: starter venues (replace or use Import/Export) ---
const starterVenues = [
  {"id":"hollywoodpaladium","name":"Hollywood Palladium","city":"Los Angeles","state":"CA","lat":34.0980,"lng":-118.3239},
  {"id":"redrocks","name":"Red Rocks Amphitheatre","city":"Morrison","state":"CO","lat":39.6654,"lng":-105.2057},
  {"id":"armorymn","name":"The Armory","city":"Minneapolis","state":"MN","lat":44.9730,"lng":-93.2657},
  {"id":"missionballroom","name":"Mission Ballroom","city":"Denver","state":"CO","lat":39.7699,"lng":-104.9690},
  {"id":"brooklynsteel","name":"Brooklyn Steel","city":"Brooklyn","state":"NY","lat":40.7191,"lng":-73.9414},
  {"id":"foxoakland","name":"Fox Theater","city":"Oakland","state":"CA","lat":37.8087,"lng":-122.2707},
  {"id":"radiuschi","name":"Radius","city":"Chicago","state":"IL","lat":41.8555,"lng":-87.6460},
  {"id":"echoplex","name":"Echoplex","city":"Los Angeles","state":"CA","lat":34.0786,"lng":-118.2608},
  {"id":"1015f","name":"1015 Folsom","city":"San Francisco","state":"CA","lat":37.7781,"lng":-122.4059},
  {"id":"paradisebos","name":"Paradise Rock Club","city":"Boston","state":"MA","lat":42.3514,"lng":-71.1166}
];

// Local storage keys
const LS_VENUES = 'unlock_map_venues_v1';
const LS_VISITED = 'unlock_map_visited_v1';

// --- State ---
let venues = loadVenues();
let visited = loadVisited();
let markers = new Map();
let map, featureGroup;

// --- Map ---
map = L.map('map', { worldCopyJump: true }).setView([39.5, -98.35], 4);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19,
  attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

featureGroup = L.featureGroup().addTo(map);

// --- Helpers ---
function loadVenues() {
  const stored = localStorage.getItem(LS_VENUES);
  if (stored) {
    try { return JSON.parse(stored); } catch {}
  }
  return starterVenues;
}
function saveVenues() {
  localStorage.setItem(LS_VENUES, JSON.stringify(venues));
}
function loadVisited() {
  const raw = localStorage.getItem(LS_VISITED);
  if (!raw) return {};
  try { return JSON.parse(raw); } catch { return {}; }
}
function saveVisited() {
  localStorage.setItem(LS_VISITED, JSON.stringify(visited));
}
function markerStyle(isVisited) {
  const color = isVisited ? '#16a34a' : '#6b7280'; // green vs gray
  return { radius: 8, weight: 1, color: color, fillColor: color, fillOpacity: 0.85 };
}
function idFor(v) {
  return v.id || (v.name + '_' + v.city + '_' + v.state).toLowerCase().replace(/[^a-z0-9]+/g, '-');
}
function normalizeVenue(v) {
  return {
    id: idFor(v),
    name: v.name,
    city: v.city || '',
    state: v.state || '',
    lat: Number(v.lat),
    lng: Number(v.lng),
    url: v.url || ''
  };
}

// --- UI render ---
function render() {
  // Map markers
  featureGroup.clearLayers();
  markers.clear();
  venues.forEach(v => {
    const isVisited = !!visited[v.id];
    const m = L.circleMarker([v.lat, v.lng], markerStyle(isVisited))
      .bindPopup(`<b>${v.name}</b><br>${v.city}, ${v.state}<br><a href="#" data-id="${v.id}" class="toggle link">${isVisited ? 'Mark unvisited' : 'Mark visited'}</a>${v.url ? `<br><a href="${v.url}" target="_blank" rel="noopener">Website</a>` : ''}`)
      .on('click', () => { /* popup handles toggle */ });
    m.addTo(featureGroup);
    markers.set(v.id, m);
  });

  // Sidebar list
  const list = document.getElementById('list');
  const q = document.getElementById('search').value.trim().toLowerCase();
  list.innerHTML = '';
  let filtered = venues.filter(v => (v.name + ' ' + v.city + ' ' + v.state).toLowerCase().includes(q));
  filtered.sort((a,b) => (visited[b.id] - visited[a.id]) || a.state.localeCompare(b.state) || a.city.localeCompare(b.city) || a.name.localeCompare(b.name));
  filtered.forEach(v => {
    const isVisited = !!visited[v.id];
    const row = document.createElement('div');
    row.className = 'venue';
    row.innerHTML = \`
      <label>
        <input type="checkbox" data-id="\${v.id}" \${isVisited ? 'checked' : ''} />
        <span><b>\${v.name}</b> — \${v.city}, \${v.state}</span>
      </label>
      <span class="badge">\${isVisited ? 'Visited' : 'Locked'}</span>
    \`;
    list.appendChild(row);
  });

  // Stats
  document.getElementById('totalCount').textContent = String(venues.length);
  const unlocked = Object.values(visited).filter(Boolean).length;
  document.getElementById('unlockedCount').textContent = String(unlocked);
  const pct = venues.length ? Math.round((unlocked / venues.length) * 100) : 0;
  document.getElementById('percent').textContent = pct + '%';
}
render();

// Fit button
document.getElementById('fitBtn').addEventListener('click', () => {
  if (!venues.length) return;
  const bounds = L.latLngBounds(venues.map(v => [v.lat, v.lng]));
  map.fitBounds(bounds.pad(0.2));
});

// Reset button
document.getElementById('resetBtn').addEventListener('click', () => {
  if (!confirm('Reset visited progress on this device?')) return;
  visited = {};
  saveVisited();
  render();
});

// Search
document.getElementById('search').addEventListener('input', render);

// Toggle via checkbox
document.getElementById('list').addEventListener('change', (e) => {
  const t = e.target;
  if (t && t.matches('input[type="checkbox"][data-id]')) {
    const id = t.getAttribute('data-id');
    visited[id] = t.checked;
    saveVisited();
    render();
    // update marker style
    if (markers.has(id)) {
      const m = markers.get(id);
      m.setStyle(markerStyle(visited[id]));
    }
  }
});

// Toggle via popup link
map.on('popupopen', (e) => {
  const popupEl = e.popup.getElement();
  popupEl.addEventListener('click', (ev) => {
    const link = ev.target.closest('a.toggle');
    if (!link) return;
    ev.preventDefault();
    const id = link.getAttribute('data-id');
    visited[id] = !visited[id];
    saveVisited();
    render();
    if (markers.has(id)) {
      markers.get(id).setStyle(markerStyle(!!visited[id]));
    }
    e.popup.setContent(e.popup.getContent().replace(/Mark (unvisited|visited)/, visited[id] ? 'Mark unvisited' : 'Mark visited'));
  }, { once: true });
});

// Import / Export
document.getElementById('exportBtn').addEventListener('click', () => {
  const data = JSON.stringify(venues, null, 2);
  document.getElementById('dataBox').value = data;
});

function parseCSV(text) {
  const lines = text.trim().split(/\r?\n/);
  const header = lines.shift().split(',').map(s => s.trim().toLowerCase());
  const idx = {name: header.indexOf('name'), city: header.indexOf('city'), state: header.indexOf('state'), lat: header.indexOf('lat'), lng: header.indexOf('lng'), url: header.indexOf('url')};
  const rows = [];
  for (const line of lines) {
    if (!line.trim()) continue;
    const cols = line.split(',').map(s => s.trim());
    rows.push({
      name: cols[idx.name],
      city: cols[idx.city],
      state: cols[idx.state],
      lat: parseFloat(cols[idx.lat]),
      lng: parseFloat(cols[idx.lng]),
      url: idx.url >= 0 ? cols[idx.url] : ''
    });
  }
  return rows;
}

document.getElementById('loadBtn').addEventListener('click', () => {
  const text = document.getElementById('dataBox').value.trim();
  if (!text) return;
  let parsed;
  try {
    if (text.startsWith('[')) {
      parsed = JSON.parse(text);
    } else {
      parsed = parseCSV(text);
    }
  } catch (err) {
    alert('Could not parse data. Provide JSON or CSV with columns: name, city, state, lat, lng');
    return;
  }
  venues = parsed.map(normalizeVenue).filter(v => isFinite(v.lat) && isFinite(v.lng) && v.name);
  saveVenues();
  render();
  alert('Loaded ' + venues.length + ' venues.');
  // auto-fit
  if (venues.length) {
    const bounds = L.latLngBounds(venues.map(v => [v.lat, v.lng]));
    map.fitBounds(bounds.pad(0.2));
  }
});
</script>
</body>
</html>
